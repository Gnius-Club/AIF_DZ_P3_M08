<!DOCTYPE html>
<html lang="es-MX">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
<title>La Redacci√≥n de la Verdad: Reportero Estrella</title>
<style>
  /* =========================================================
   * LA REDACCI√ìN DE LA VERDAD: REPORTERO ESTRELLA
   * Juego educativo (HECHO vs OPINI√ìN vs NOTICIA FALSA)
   * P√∫blico: 3¬∞ de primaria | ES-MX | Desktop/Tablet
   * ---------------------------------------------------------
   * Docentes: todo es editable. Busca los bloques:
   *  - VARIABLES DE TEMA (colores, tama√±os)
   *  - TEXTOS VOZ EN OFF
   *  - DATOS DE LOS CASOS (array 'casosDetallados' y 'casos')
   *  - SONS (WebAudio) y m√∫sica
   *  - ANIMACIONES y ACCESIBILIDAD
   * =======================================================*/

  /* ===================== VARIABLES DE TEMA ===================== */
  :root{
    --bg:#f4f1ea;               /* tono papel peri√≥dico */
    --ink:#1b1b1b;              /* ‚Äútinta‚Äù */
    --brand:#e63946;            /* rojo prensa */
    --accent:#2a9d8f;           /* turquesa brillante */
    --accent2:#f4a261;          /* naranja brillante */
    --good:#00a86b;             /* correcto */
    --warn:#ffb703;             /* aviso */
    --bad:#d90429;              /* grave */
    --panel:#ffffff;
    --contrastEdge:#000;
    --shadow:0 6px 16px rgba(0,0,0,.15);
    --focus: 0 0 0 4px rgba(42,157,143,.35);
    --touch: 72px;              /* zonas t√°ctiles ‚â• 64px */
    --radius:16px;
    --font: "Atkinson Hyperlegible", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  }
  /* Alto contraste */
  .alto-contraste :root, body.alto-contraste{
    --bg:#000;
    --ink:#fff;
    --panel:#000;
    --brand:#fff;
    --accent:#fff;
    --accent2:#fff;
    --good:#fff;
    --warn:#fff;
    --bad:#fff;
    --shadow:none;
    --focus: 0 0 0 4px #fff;
  }

  /* ===================== LAYOUT BASE ===================== */
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--ink); font-family:var(--font); line-height:1.15;
  }
  #app{min-height:100dvh; display:flex; flex-direction:column}
  header{
    padding:12px clamp(12px,2vw,24px);
    display:flex; align-items:center; gap:12px; flex-wrap:wrap;
    border-bottom:4px double var(--ink);
    background:linear-gradient(180deg, #fff8, #0000), var(--panel);
    position:sticky; top:0; z-index:10;
  }
  .logo {
    font-weight:900; letter-spacing:.5px; text-transform:uppercase;
    display:flex; align-items:center; gap:10px; font-size: clamp(16px, 2vw, 20px);
  }
  .logo .badge{display:inline-grid; place-items:center; width:36px; height:36px; border:2px solid var(--ink); border-radius:6px; background:#fff}
  .controls{margin-left:auto; display:flex; flex-wrap:wrap; gap:10px}
  .toggle{
    display:inline-flex; align-items:center; gap:8px; padding:6px 10px;
    border:2px solid var(--ink); border-radius:999px; background:#fff; cursor:pointer; user-select:none;
  }
  .toggle input{appearance:none; width:22px; height:22px; border:2px solid var(--ink); border-radius:999px; display:inline-block; position:relative}
  .toggle input:checked::after{content:""; position:absolute; inset:2px; background:var(--accent); border-radius:999px}
  .btn{
    display:inline-flex; align-items:center; justify-content:center; gap:8px;
    min-height: var(--touch); padding: 12px 18px; font-weight:700; border:3px solid var(--ink);
    background: #fff; border-radius:var(--radius); cursor:pointer; box-shadow:var(--shadow);
    transition: transform .08s ease;
  }
  .btn:active{transform: translateY(2px)}
  .btn.primary{background: var(--accent); color:#fff; border-color:#0e5b52}
  .btn.secondary{background: var(--accent2); color:#000; border-color:#b46a2f}
  .btn.ghost{background:transparent}
  .btn.block{width:100%}

  main{flex:1; display:grid; place-items:center; padding: clamp(12px,2vw,24px)}
  section.panel{
    width:min(1100px, 96vw); min-height: min(680px, 80vh);
    background:var(--panel); border:3px solid var(--ink); border-radius:var(--radius);
    padding: clamp(16px, 2.2vw, 28px);
    box-shadow: var(--shadow);
    display:grid; grid-template-rows:auto 1fr auto; gap:12px;
  }
  h1,h2,h3{margin:.2em 0}
  h1{font-size: clamp(28px, 4.5vw, 44px); line-height:1.05}
  h2{font-size: clamp(18px, 2.8vw, 28px)}
  p{margin:.4em 0 .6em}

  /* ===================== PANTALLA INICIO ===================== */
  .start-grid{
    display:grid; grid-template-columns: 1.2fr .8fr; gap: clamp(14px,2.2vw,28px);
    align-items:center;
  }
  .newspaper{
    border:3px solid var(--ink); border-radius:12px; padding:16px; background:repeating-linear-gradient( #fff, #fff 28px, #f2f2f2 28px, #f2f2f2 56px);
    position:relative; overflow:hidden; box-shadow:var(--shadow);
  }
  .newspaper .masthead{font-weight:900; font-size: clamp(20px,2.4vw,28px); text-transform:uppercase; letter-spacing:1px; border-bottom:3px double var(--ink); padding-bottom:8px; margin-bottom:10px}
  .newspaper .hero{display:grid; grid-template-columns:120px 1fr; gap:12px; align-items:center}
  .avatar-editor{
    width:120px; height:120px; border:3px solid var(--ink); border-radius:12px; display:grid; place-items:center; background:
      radial-gradient(circle at 35% 35%, #ffd, #fff 50%),
      linear-gradient(#fdfdfd, #f0f0f0);
    font-size:64px;
  }
  .cta-col{display:grid; gap:12px}
  .tagline{font-weight:700; font-size: clamp(14px, 1.9vw, 18px)}
  .pill{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border:2px dashed var(--ink); border-radius:999px; background:#fff}

  /* ===================== MODAL C√ìMO SE JUEGA ===================== */
  .modal{position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; place-items:center; padding:16px; z-index:999}
  .modal.open{display:grid}
  .modal .sheet{width:min(900px,95vw); background:var(--panel); color:var(--ink); border:3px solid var(--ink); border-radius:16px; padding:18px; box-shadow:var(--shadow)}
  .how-grid{display:grid; gap:12px}
  .slides{display:grid; grid-template-columns:1fr; min-height:280px; border:2px dashed var(--ink); border-radius:12px; place-items:center; padding:16px; text-align:center}
  .slide-illu{font-size: clamp(48px, 5vw, 84px)}
  .slide-caption{font-weight:800; font-size: clamp(18px, 2.3vw, 24px)}
  .nav-slides{display:flex; justify-content:space-between; align-items:center; gap:10px; margin-top:8px}
  .dots{display:flex; gap:6px}
  .dot{width:12px; height:12px; border:2px solid var(--ink); border-radius:999px}
  .dot.active{background:var(--accent)}

  /* ===================== BRIEFING ===================== */
  .brief-grid{display:grid; grid-template-columns: 220px 1fr; gap:16px}
  .editor-card{border:3px solid var(--ink); border-radius:12px; padding:10px; display:grid; gap:8px; align-content:start; background: #fff}
  .editor-ava{font-size:88px; display:grid; place-items:center; border:3px solid var(--ink); border-radius:12px; background:#ffe}
  .speech{border:3px solid var(--ink); border-radius:12px; padding:12px; background:#fdfcf7; font-weight:800}
  .demo-row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  .card{
    border:3px solid var(--ink); border-radius:12px; padding:12px; background:#fff;
    min-height:120px; display:grid; gap:8px; position:relative; touch-action:none;
  }
  .stamp {
    position:absolute; inset:auto 8px 8px auto; font-size:28px; padding:6px 12px; border:3px solid; border-radius:8px;
    transform:scale(.6) rotate(-10deg); opacity:0; pointer-events:none;
  }
  .stamp.show{animation: stamp .45s ease forwards}
  @keyframes stamp{
    0%{transform:scale(.4) rotate(-12deg); opacity:0}
    60%{transform:scale(1.1) rotate(-6deg); opacity:1}
    100%{transform:scale(1) rotate(-8deg); opacity:1}
  }
  .stamp.ok{color:var(--good); border-color:var(--good)}
  .stamp.op{color:#333; border-color:#333; background:#ffd}
  .kit{display:flex; gap:8px; flex-wrap:wrap}
  .tool{
    min-width: var(--touch); min-height: var(--touch);
    display:grid; place-items:center; font-size:28px; border:3px solid var(--ink); border-radius:14px;
    padding:8px; cursor:pointer; background:#fff; position:relative;
  }
  .tool .label{position:absolute; bottom:-6px; transform:translateY(100%); font-size:12px; font-weight:800; background:#fff; padding:2px 6px; border:2px solid var(--ink); border-radius:999px}

  /* ===================== MISI√ìN ===================== */
  .mission-grid{display:grid; grid-template-columns: 260px 1fr 260px; gap:12px}
  .tray{border:3px solid var(--ink); border-radius:12px; background:#fafafa; padding:10px; display:grid; gap:10px; align-content:start}
  .tray-title{font-weight:900; display:flex; align-items:center; gap:8px}
  .inbox-list{display:grid; gap:8px}
  .mini{border:2px dashed var(--ink); border-radius:8px; padding:8px; background:#fff; font-size:12px}
  .analysis{border:3px solid var(--ink); border-radius:12px; padding:12px; background:repeating-linear-gradient( #fff, #fff 34px, #f6f6f6 34px, #f6f6f6 68px)}
  .dropzones{display:grid; grid-template-columns: repeat(3,1fr); gap:8px; margin-top:8px}
  .drop{
    min-height: var(--touch); display:grid; grid-auto-flow:column; place-items:center; gap:8px; padding:12px; border:3px dashed var(--ink); border-radius:12px; background:#fff; position:relative;
    outline:none;
  }
  .drop[data-type="HECHO"]{background:#e8fff4}
  .drop[data-type="OPINION"]{background:#fff7e8}
  .drop[data-type="FALSA"]{background:#ffe8e8}
  /* Modo daltonismo: se suman texturas (rayas/puntos) */
  body.daltonismo .drop[data-type="HECHO"]{background:
      repeating-linear-gradient(45deg, #fff, #fff 6px, #e8fff4 6px, #e8fff4 12px);}
  body.daltonismo .drop[data-type="OPINION"]{background:
      repeating-linear-gradient(90deg, #fff, #fff 6px, #fff7e8 6px, #fff7e8 12px);}
  body.daltonismo .drop[data-type="FALSA"]{background:
      repeating-linear-gradient(135deg, #fff, #fff 6px, #ffe8e8 6px, #ffe8e8 12px);}
  .drop:focus{box-shadow:var(--focus)}
  .hint-bubble{
    position:absolute; top:-10px; right:-10px; transform:translateY(-100%); background:#fff; border:3px solid var(--ink); border-radius:12px; padding:8px 10px; font-weight:800;
    box-shadow:var(--shadow);
  }
  .tools-row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  .meter{
    height:20px; background:#eee; border:3px solid var(--ink); border-radius:999px; overflow:hidden; position:relative;
  }
  .meter .bar{height:100%; width:60%; background:linear-gradient(90deg, var(--good), #6ad6b5)}
  .counter{font-weight:900}
  .caption{
    position:fixed; left:50%; bottom:10px; transform:translateX(-50%);
    background:rgba(0,0,0,.8); color:#fff; padding:6px 10px; border-radius:999px; font-weight:800; letter-spacing:.2px; display:none; z-index:1000;
  }
  .caption.show{display:block}

  /* Drag */
  .draggable{cursor:grab}
  .dragging{opacity:.9; cursor:grabbing; box-shadow: 0 12px 30px rgba(0,0,0,.25)}
  .target-glow{box-shadow:0 0 0 6px rgba(0,0,0,.12) inset, var(--focus)}

  /* ===================== RESULTADOS ===================== */
  .result-grid{display:grid; grid-template-columns:1fr .9fr; gap:12px; align-items:start}
  .trophy{font-size: 120px; display:grid; place-items:center; border:3px solid var(--ink); border-radius:16px; background:#fff}
  .summary{border:3px solid var(--ink); border-radius:16px; padding:12px; background:#fff}
  .list{display:grid; gap:6px}
  .row{display:flex; justify-content:space-between; gap:10px; padding:8px 10px; border-bottom:2px dashed var(--ink)}
  .row:last-child{border-bottom:none}
  .award{font-weight:900; font-size: clamp(20px, 3vw, 28px);}

  /* ===================== UTILES ===================== */
  .sr-only{position:absolute!important; width:1px!important; height:1px!important; padding:0!important; margin:-1px!important; overflow:hidden!important; clip:rect(0,0,0,0)!important; white-space:nowrap!important; border:0!important}
  .flex{display:flex; gap:10px; flex-wrap:wrap}
  .right{justify-content:flex-end}
</style>
</head>
<body>
<div id="app">
  <header aria-label="Barra superior">
    <div class="logo" aria-label="T√≠tulo del juego">
      <div class="badge">üì∞</div>
      <div>La Redacci√≥n de la Verdad: <strong>Reportero Estrella</strong></div>
    </div>
    <div class="controls" role="toolbar" aria-label="Controles r√°pidos">
      <label class="toggle" title="M√∫sica">
        <input id="tg-music" type="checkbox" checked>
        <span>üéµ M√∫sica</span>
      </label>
      <label class="toggle" title="Voz en off">
        <input id="tg-voice" type="checkbox" checked>
        <span>üó£Ô∏è Voz</span>
      </label>
      <label class="toggle" title="Subt√≠tulos">
        <input id="tg-captions" type="checkbox" checked>
        <span>üí¨ Subt√≠tulos</span>
      </label>
      <label class="toggle" title="Alto contraste">
        <input id="tg-contrast" type="checkbox">
        <span>‚ö´ Alto Contraste</span>
      </label>
      <label class="toggle" title="Modo daltonismo">
        <input id="tg-cvd" type="checkbox">
        <span>üß© Daltonismo</span>
      </label>
    </div>
  </header>

  <main>
    <!-- ===================== INICIO ===================== -->
    <section id="screen-inicio" class="panel" aria-labelledby="tit-inicio">
      <div class="start-grid">
        <div class="newspaper" aria-label="Portada">
          <div class="masthead">El Diario Escolar</div>
          <div class="hero">
            <div class="avatar-editor" aria-hidden="true">üë®‚Äçüíº</div>
            <div>
              <h1 id="tit-inicio">La Redacci√≥n de la Verdad</h1>
              <h2>Reportero Estrella</h2>
              <p class="tagline">Distingue <strong>HECHO</strong>, <strong>OPINI√ìN</strong> y <strong>NOTICIA FALSA</strong>.</p>
              <p class="pill">Ciudadan√≠a Digital ¬∑ 3¬∞ Primaria</p>
            </div>
          </div>
        </div>
        <div class="cta-col">
          <button id="btn-jugar" class="btn primary" aria-label="Iniciar juego">‚ñ∂Ô∏è Jugar</button>
          <button id="btn-como" class="btn secondary" aria-label="C√≥mo se juega">‚ùì C√≥mo se juega</button>
          <div class="flex">
            <button id="btn-acces" class="btn ghost" title="Accesibilidad">‚ôø Accesibilidad</button>
            <button id="btn-credits" class="btn ghost" title="Cr√©ditos">‚ÑπÔ∏è Cr√©ditos</button>
          </div>
          <div class="mini" role="note">Tip: Teclado ‚Äî 1=üîé, 2=‚öñÔ∏è, 3=üéØ ¬∑ H=HECHO, O=OPINI√ìN, F=FALSA</div>
        </div>
      </div>
      <div class="flex right">
        <span class="sr-only" aria-live="polite" id="live-init"></span>
      </div>
    </section>

    <!-- ===================== BRIEFING ===================== -->
    <section id="screen-brief" class="panel" hidden aria-labelledby="tit-brief">
      <h2 id="tit-brief">Briefing en la Redacci√≥n</h2>
      <div class="brief-grid">
        <div class="editor-card" aria-label="Editor en Jefe">
          <div class="editor-ava" aria-hidden="true">üßë‚Äç‚úàÔ∏è</div>
          <div class="speech" id="brief-line" aria-live="polite">Regla #1: Hecho se comprueba. Opini√≥n es lo que alguien cree.</div>
          <div class="kit" aria-label="Kit de verificaci√≥n">
            <div class="tool" aria-label="Lupa de fuentes" data-tool="fuente" tabindex="0">üîé<span class="label">¬øQui√©n lo dice?</span></div>
            <div class="tool" aria-label="Balanza de evidencia" data-tool="evidencia" tabindex="0">‚öñÔ∏è<span class="label">¬øComprobable?</span></div>
            <div class="tool" aria-label="Detector de intenci√≥n" data-tool="intencion" tabindex="0">üéØ<span class="label">¬øPara qu√©?</span></div>
          </div>
        </div>
        <div>
          <div class="demo-row" aria-label="Demostraci√≥n">
            <div class="card" id="demo1">
              <strong>Tarjeta:</strong>
              <div>‚ÄúEl sol es una estrella‚Äù.</div>
              <div class="stamp ok" id="stamp1">‚úÖ HECHO</div>
            </div>
            <div class="card" id="demo2">
              <strong>Tarjeta:</strong>
              <div>‚ÄúEl helado de chocolate es el mejor‚Äù.</div>
              <div class="stamp op" id="stamp2">ü§î OPINI√ìN</div>
            </div>
          </div>
          <div class="flex right" style="margin-top:10px">
            <button id="btn-entendido" class="btn primary">¬°Entendido!</button>
          </div>
        </div>
      </div>
    </section>

    <!-- ===================== MISI√ìN ===================== -->
    <section id="screen-mision" class="panel" hidden aria-labelledby="tit-mision">
      <div class="tools-row" style="justify-content:space-between">
        <h2 id="tit-mision">Misi√≥n: Clasifica los despachos</h2>
        <div class="flex" role="toolbar" aria-label="Herramientas">
          <div class="tool" title="¬øQui√©n lo dice? (1)" data-tool="fuente" tabindex="0">üîé</div>
          <div class="tool" title="¬øSe puede comprobar? (2)" data-tool="evidencia" tabindex="0">‚öñÔ∏è</div>
          <div class="tool" title="¬øPor qu√© lo publican? (3)" data-tool="intencion" tabindex="0">üéØ</div>
        </div>
      </div>

      <div class="mission-grid">
        <aside class="tray" aria-label="Bandeja de Entrada">
          <div class="tray-title">üì• Entrada</div>
          <div id="inbox" class="inbox-list"></div>
          <div class="mini">Casos <span id="caseCounter" class="counter">1/5</span></div>
          <div class="mini">Modo: <strong id="modeTag">Normal</strong></div>
        </aside>

        <div class="analysis" aria-label="√Årea de an√°lisis">
          <div id="currentCard" class="card draggable" tabindex="0" aria-describedby="cardHelp">
            <div class="hint-bubble" id="miniHint" hidden>Usa üîé, ‚öñÔ∏è o üéØ</div>
            <strong>Despacho</strong>
            <div id="cardText">‚Äî</div>
            <div class="stamp ok" id="bigStamp">‚Äî</div>
          </div>
          <div id="cardHelp" class="mini">Arrastra a una bandeja o usa H/O/F</div>
          <div class="dropzones" aria-label="Bandejas de salida">
            <button class="drop" data-type="HECHO" tabindex="0" aria-label="Bandeja HECHO">‚úÖ HECHO</button>
            <button class="drop" data-type="OPINION" tabindex="0" aria-label="Bandeja OPINI√ìN">ü§î OPINI√ìN</button>
            <button class="drop" data-type="FALSA" tabindex="0" aria-label="Bandeja NOTICIA FALSA">üóëÔ∏è FALSA</button>
          </div>
          <div class="flex" style="margin-top:8px">
            <div class="meter" aria-label="Medidor de confianza" role="meter" aria-valuemin="0" aria-valuemax="100" aria-valuenow="60">
              <div id="bar" class="bar" style="width:60%"></div>
            </div>
            <div class="mini">Confianza: <strong id="confVal">60</strong>/100</div>
          </div>
        </div>

        <aside class="tray" aria-label="Controles r√°pidos">
          <div class="tray-title">‚öôÔ∏è Controles</div>
          <button id="btn-retry" class="btn block">üîÅ Reintentar</button>
          <button id="btn-toggle-voice" class="btn block">üîá Silenciar Voz</button>
          <button id="btn-toggle-captions" class="btn block">üí¨ Subt√≠tulos</button>
          <button id="btn-access" class="btn block">‚ôø Accesibilidad</button>
          <div class="mini">Atajos: 1/2/3 herramientas ¬∑ H/O/F bandejas</div>
          <div class="mini">Enter aplica foco ¬∑ Tab navega</div>
        </aside>
      </div>
    </section>

    <!-- ===================== RESULTADO ===================== -->
    <section id="screen-resultado" class="panel" hidden aria-labelledby="tit-res">
      <h2 id="tit-res">Resultados</h2>
      <div class="result-grid">
        <div class="trophy" id="trophy" aria-hidden="true">üèÜ</div>
        <div class="summary">
          <div class="award" id="awardTitle">Reportero del A√±o</div>
          <p id="finalPhrase">‚ÄúUn hecho es dato; opini√≥n es sentir. Yo los distingo para no confundir.‚Äù</p>
          <div class="list">
            <div class="row"><span>Despachos analizados</span><strong id="sumTotal">5</strong></div>
            <div class="row"><span>Hechos</span><strong id="sumHechos">0</strong></div>
            <div class="row"><span>Opiniones</span><strong id="sumOpiniones">0</strong></div>
            <div class="row"><span>Noticias falsas</span><strong id="sumFalsas">0</strong></div>
            <div class="row"><span>Confianza final</span><strong id="sumConf">100</strong></div>
          </div>
          <div class="flex right" style="margin-top:10px">
            <button id="btn-jugar-de-nuevo" class="btn primary">‚ñ∂Ô∏è Jugar de nuevo</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Subt√≠tulos breves -->
  <div id="captions" class="caption" role="status" aria-live="polite">‚Äî</div>

  <!-- Modal C√≥mo se juega -->
  <div id="modal" class="modal" aria-modal="true" role="dialog" aria-labelledby="howTitle" aria-hidden="true">
    <div class="sheet how-grid">
      <h3 id="howTitle">C√≥mo se juega</h3>
      <div class="slides">
        <div id="slide-illu" class="slide-illu">üì∞üß†</div>
        <div id="slide-caption" class="slide-caption">Lee el despacho.</div>
      </div>
      <div class="nav-slides">
        <button id="prevSlide" class="btn">‚óÄ</button>
        <div class="dots">
          <div class="dot active"></div>
          <div class="dot"></div>
          <div class="dot"></div>
        </div>
        <button id="nextSlide" class="btn">‚ñ∂</button>
      </div>
      <div class="flex right">
        <button id="closeModal" class="btn primary">¬°Vamos!</button>
      </div>
    </div>
  </div>
</div>

<script>
/* =========================================================
 * L A   R E D A C C I √ì N   D E   L A   V E R D A D
 * ---------------------------------------------------------
 * ESTRUCTURA DE DATOS SOLICITADA (visible para docentes)
 * =======================================================*/
const casos = [
  {id:1, tipoCorrecto:"HECHO", texto:"Ciencia Kids: Los elefantes...", pistas:{fuente:"Educativa verificada", evidencia:"Datos y n√∫meros", intencion:"Informar"}},
  {id:2, tipoCorrecto:"OPINION", texto:"Bloguero: La pizza con pi√±a...", pistas:{fuente:"Blog personal", evidencia:"Gusto/sentimiento", intencion:"Persuadir"}},
  {id:3, tipoCorrecto:"OPINION", texto:"Cr√≠tico: Aventura Espacial 3 es...", pistas:{fuente:"Rese√±ador", evidencia:"Juicios de valor", intencion:"Opinar"}},
  {id:4, tipoCorrecto:"OPINION", texto:"Patrocinado: S√∫per Salto 20%...", pistas:{fuente:"Marca interesada", evidencia:"Dato puntual", intencion:"Vender"}},
  {id:5, tipoCorrecto:"FALSA", texto:"Br√≥coli te hace invisible", pistas:{fuente:"Sitio de bromas", evidencia:"Imposible/ciencia", intencion:"Clickbait"}}
];

/* =========================================================
 * DATOS COMPLETOS DE LOS 5 DESPACHOS
 * (texto para ni√±os + pistas de cada herramienta)
 * =======================================================*/
const casosDetallados = [
  {
    id:1, tipoCorrecto:"HECHO",
    texto:`Video de ‚ÄúCiencia Kids‚Äù: ‚ÄúLos elefantes son los mam√≠feros terrestres m√°s grandes. Pueden pesar hasta 6,000 kilos.‚Äù`,
    pistas:{
      fuente:"Fuente educativa verificada.",
      evidencia:"Tiene datos y n√∫meros ‚Üí comprobable.",
      intencion:"Informar."
    }
  },
  {
    id:2, tipoCorrecto:"OPINION",
    texto:`Bloguero: ‚Äú¬°La pizza con pi√±a es la m√°s deliciosa del universo! ¬°Todos deber√≠an probarla!‚Äù`,
    pistas:{
      fuente:"Autor: blog personal.",
      evidencia:"Palabras de gusto/sentimiento.",
      intencion:"Persuadir a probar."
    }
  },
  {
    id:3, tipoCorrecto:"OPINION",
    texto:`Cr√≠tico: ‚ÄúEl juego ‚ÄòAventura Espacial 3‚Äô es una decepci√≥n total. Gr√°ficos anticuados, historia aburrida. El peor del a√±o.‚Äù`,
    pistas:{
      fuente:"Rese√±ador de juegos.",
      evidencia:"Juicios de valor, no mediciones.",
      intencion:"Opinar/valorar."
    }
  },
  {
    id:4, tipoCorrecto:"OPINION",
    texto:`Video patrocinado: ‚ÄúEstudios demuestran que las zapatillas S√∫per Salto aumentan tu salto un 20%.‚Äù`,
    pistas:{
      fuente:"Fuente: la misma marca.",
      evidencia:"Dato espec√≠fico (20%).",
      intencion:"Vender producto."
    }
  },
  {
    id:5, tipoCorrecto:"FALSA",
    texto:`Titular: ‚Äú¬°Cient√≠ficos confirman que comer br√≥coli te hace invisible!‚Äù`,
    pistas:{
      fuente:"BromasDiarias.net (sitio de chistes).",
      evidencia:"Contradice ciencia; imposible.",
      intencion:"Clickbait/broma."
    }
  }
];

/* =========================================================
 * ESTADO GLOBAL DEL JUEGO
 * =======================================================*/
const state = {
  stage: 'inicio',          // inicio -> briefing -> mision -> resultado
  voiceOn: true,
  captionsOn: true,
  musicOn: true,
  highContrast: false,
  cvdMode: false,
  confidence: 60,           // 0 - 100
  index: 0,                 // caso actual (0..4)
  resolved: 0,
  counts: {HECHO:0, OPINION:0, FALSA:0},
  bpm: 84,                  // m√∫sica base
  lastToolHint: '',         // texto de pista breve
  shuffle: false,           // modo √öltima Hora (opcional)
  order: [...Array(casosDetallados.length).keys()], // 0..4
};

/* =========================================================
 * UTILIDADES DE UI
 * =======================================================*/
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));

function showScreen(id){
  ["#screen-inicio","#screen-brief","#screen-mision","#screen-resultado"].forEach(s=>{
    const el=$(s);
    if(!el) return;
    if(s === id){ el.hidden = false; } else { el.hidden = true; }
  });
  if(id==="#screen-inicio") state.stage='inicio';
  if(id==="#screen-brief") state.stage='briefing';
  if(id==="#screen-mision") state.stage='mision';
  if(id==="#screen-resultado") state.stage='resultado';
}

function renderInbox(){
  const inbox = $("#inbox");
  inbox.innerHTML="";
  const remaining = state.order.slice(state.index);
  remaining.forEach((idx, i)=>{
    const cas = casosDetallados[idx];
    const mini = document.createElement('div');
    mini.className='mini';
    mini.textContent = `#${cas.id} ¬∑ ${shorten(cas.texto, 38)}`;
    inbox.appendChild(mini);
  });
  $("#caseCounter").textContent = `${state.index+1}/${casosDetallados.length}`;
}

function renderCard(){
  const cas = currentCase();
  $("#cardText").textContent = cas ? cas.texto : "‚Äî";
  $("#bigStamp").style.opacity=0;
  $("#miniHint").hidden=false;
}

function currentCase(){
  const idx = state.order[state.index];
  return casosDetallados[idx];
}

function setConfidence(delta){
  state.confidence = clamp(state.confidence + delta, 0, 100);
  $("#confVal").textContent = state.confidence;
  $("#bar").style.width = state.confidence + "%";
  $(".meter").setAttribute('aria-valuenow', String(state.confidence));
  if(state.confidence<=0){
    endGame(false);
  }
}

function shorten(t, n){ return t.length>n ? t.slice(0,n-1)+"‚Ä¶" : t; }
function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

/* =========================================================
 * VOZ EN OFF + SUBT√çTULOS
 * =======================================================*/
let voice=null;
function findVoice(){
  const voices = speechSynthesis.getVoices();
  // Selecci√≥n preferida: espa√±ol (M√©xico) si existe
  voice = voices.find(v=>/es(-|_)MX/i.test(v.lang)) ||
          voices.find(v=>/es(-|_)ES/i.test(v.lang)) ||
          voices.find(v=>/es/i.test(v.lang)) || null;
}
if('speechSynthesis' in window){
  window.speechSynthesis.onvoiceschanged = findVoice;
  findVoice();
}

let speaking=false;
function speak(text, caption= ""){
  if(!state.voiceOn || !('speechSynthesis' in window)) { showCaption(caption||text); return; }
  try{
    speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    if(voice) u.voice=voice;
    u.rate=0.98; u.pitch=1; u.lang = voice?.lang || 'es-MX';
    speaking=true;
    u.onend = ()=>{ speaking=false; };
    speechSynthesis.speak(u);
    showCaption(caption || microCaption(text));
  }catch(e){ /* no-op */ }
}
function microCaption(t){
  // Genera subt√≠tulo breve (m√°x 7 palabras)
  const words = t.split(/\s+/).slice(0,7);
  return words.join(" ").replace(/[.,;:!?]$/,"") + (words.length>=7?"‚Ä¶":"");
}
let capTO=null;
function showCaption(t){
  if(!state.captionsOn) return;
  const el=$("#captions");
  el.textContent = t;
  el.classList.add("show");
  clearTimeout(capTO);
  capTO=setTimeout(()=>el.classList.remove("show"), 2500);
}

/* =========================================================
 * SONIDOS (WebAudio) ‚Äî sin archivos externos
 * =======================================================*/
let AC=null;
function ac(){ if(!AC) AC = new (window.AudioContext||window.webkitAudioContext)(); return AC; }

function beep(freq=440, dur=0.12, type='sine', gain=0.06){
  const ctx=ac();
  const o=ctx.createOscillator(); const g=ctx.createGain();
  o.type=type; o.frequency.value=freq;
  g.gain.value=gain;
  o.connect(g).connect(ctx.destination);
  const t=ctx.currentTime;
  o.start(t);
  o.stop(t+dur);
}

function sfx(type){
  // ‚Äúprensa imprime‚Äù (acierto), ‚Äúerror de redacci√≥n‚Äù (fallo), ‚Äúalarma fake news‚Äù (grave)
  const ctx=ac();
  if(type==='success'){
    // peque√±a r√°faga ‚Äúprensa‚Äù
    [220,330,440].forEach((f,i)=> setTimeout(()=>beep(f,0.08,'square',0.05), i*60));
  }else if(type==='soft'){
    beep(220,0.08,'triangle',0.05); setTimeout(()=>beep(180,0.12,'triangle',0.04),90);
  }else if(type==='alarm'){
    // sirena breve
    let t0=ctx.currentTime;
    const o=ctx.createOscillator(), g=ctx.createGain();
    o.connect(g).connect(ctx.destination);
    o.type='sawtooth'; g.gain.value=0.05;
    o.frequency.setValueAtTime(400, t0);
    o.frequency.linearRampToValueAtTime(800, t0+0.25);
    o.frequency.linearRampToValueAtTime(400, t0+0.5);
    o.start(t0); o.stop(t0+0.6);
  }
}

/* ===================== M√öSICA TIPO NEWSROOM ===================== */
let musicTimer=null;
function startMusic(){
  stopMusic();
  if(!state.musicOn) return;
  const ctx=ac(); // ensure context
  let step=0;
  function tick(){
    // patr√≥n simple: bombo, caja, campanilla ‚Äî sube BPM seg√∫n progreso
    const prog = state.index / (casosDetallados.length-1);
    const bpm = 84 + Math.round( prog * 24 ); // acelera
    state.bpm=bpm;
    const beatMs = 60000/bpm;
    // bombo
    if(step%4===0){ beep(120,0.06,'sine',0.07); }
    // caja
    if(step%4===2){ beep(200,0.05,'square',0.05); }
    // campanilla
    if(step%2===1){ setTimeout(()=>beep(880,0.02,'triangle',0.03), 20); }
    step=(step+1)%16;
    musicTimer = setTimeout(tick, beatMs/2);
  }
  tick();
}
function stopMusic(){ if(musicTimer){ clearTimeout(musicTimer); musicTimer=null; } }

/* =========================================================
 * BRIEFING: animaci√≥n de sellos
 * =======================================================*/
function runBriefing(){
  showScreen("#screen-brief");
  speak("Regla n√∫mero uno: Hecho se comprueba. Opini√≥n es lo que alguien cree.","Regla #1: Hecho vs opini√≥n");
  setTimeout(()=> $("#stamp1").classList.add("show"), 700);
  setTimeout(()=> { $("#stamp2").classList.add("show"); }, 1300);
  setTimeout(()=>{
    speak("Este es tu kit de verificaci√≥n. Lupa, balanza y detector.","Tu kit de verificaci√≥n");
  }, 1500);
}

/* =========================================================
 * MISI√ìN ‚Äî Render, herramientas, clasificaci√≥n
 * =======================================================*/
function startMission(){
  showScreen("#screen-mision");
  state.index=0; state.resolved=0; state.confidence=60; state.counts={HECHO:0,OPINION:0,FALSA:0};
  $("#confVal").textContent=state.confidence; $("#bar").style.width=state.confidence+"%";
  $("#modeTag").textContent = state.shuffle ? "√öltima Hora" : "Normal";
  if(state.shuffle){ state.order = shuffle([...state.order]); }
  renderInbox(); renderCard(); startMusic();
  speak("Objetivo: decide si es HECHO, OPINI√ìN o NOTICIA FALSA.","Clasifica correctamente");
}

function nextCaso(){
  state.index++;
  if(state.index >= casosDetallados.length){
    endGame(true);
  }else{
    renderInbox(); renderCard(); startMusic();
  }
}

function applyTool(tool){
  const cas = currentCase(); if(!cas) return;
  const map = {fuente:"üîé", evidencia:"‚öñÔ∏è", intencion:"üéØ"};
  const hint = cas.pistas[tool] || "";
  state.lastToolHint = hint;
  showHint(`${map[tool]} ${hint}`);
  // voz breve
  speak(hint, hint);
  // efecto visual
  const card=$("#currentCard"); card.classList.add("target-glow");
  setTimeout(()=>card.classList.remove("target-glow"), 600);
}

function showHint(text){
  const b=$("#miniHint");
  b.hidden=false; b.textContent = text;
  b.animate([{transform:"translateY(-120%)",opacity:0},{transform:"translateY(-100%)",opacity:1}], {duration:180, fill:"forwards"});
  setTimeout(()=>{
    b.animate([{opacity:1},{opacity:0}], {duration:250, fill:"forwards"});
  }, 1600);
}

function classify(tipo){
  const cas = currentCase(); if(!cas) return;
  const correct = cas.tipoCorrecto;
  const big=$("#bigStamp");
  const isGrave = (cas.id===5 && tipo!=="FALSA"); // publicar falsa
  const isCorrect = (tipo===correct);

  if(isCorrect){
    sfx('success');
    setConfidence(+20);
    state.resolved++;
    state.counts[tipo]++; // sumar por tipo correcto
    big.textContent = (tipo==="HECHO"?"‚úÖ HECHO": tipo==="OPINION"?"ü§î OPINI√ìN":"üóëÔ∏è FALSA");
    big.className = "stamp ok show";
    speak("¬°Clasificaci√≥n correcta!","¬°Correcto!");
    setTimeout(()=> nextCaso(), 900);
  }else{
    if(isGrave){
      sfx('alarm');
      setConfidence(-40);
      speak("¬°Alerta: noticia falsa! Pide retracto.","¬°Alerta: noticia falsa!");
      // no avanzamos; permitimos retracto (intento otra vez)
      flashDrop("FALSA");
    }else{
      sfx('soft');
      setConfidence(-15);
      speak("Revisa evidencia: ¬øcomprobable o sentir?","Revisa: dato o sentir");
      // permitir corregir: no avanzamos
      flashDrop(correct);
    }
  }
}

function flashDrop(type){
  const el = $(`.drop[data-type="${type}"]`);
  if(!el) return;
  el.classList.add("target-glow");
  setTimeout(()=> el.classList.remove("target-glow"), 750);
}

/* =========================================================
 * DRAG & DROP ACCESIBLE (pointer + teclado)
 * =======================================================*/
let dragging=false, dragOffset=[0,0];

function setupDrag(){
  const card=$("#currentCard");
  card.addEventListener("pointerdown", (e)=>{
    dragging=true; card.setPointerCapture(e.pointerId);
    card.classList.add("dragging");
    const rect=card.getBoundingClientRect();
    dragOffset=[e.clientX-rect.left, e.clientY-rect.top];
  });
  card.addEventListener("pointermove", (e)=>{
    if(!dragging) return;
    const x=e.clientX-dragOffset[0], y=e.clientY-dragOffset[1];
    card.style.position="absolute"; card.style.left=x+"px"; card.style.top=y+"px"; card.style.zIndex=20;
    // hover sobre dropzones
    $$(".drop").forEach(d=>{
      const r=d.getBoundingClientRect();
      const inside = e.clientX>r.left && e.clientX<r.right && e.clientY>r.top && e.clientY<r.bottom;
      d.classList.toggle("target-glow", inside);
    });
  });
  card.addEventListener("pointerup", (e)=>{
    if(!dragging) return;
    dragging=false; card.releasePointerCapture(e.pointerId);
    card.classList.remove("dragging");
    // drop?
    let dropped=null;
    $$(".drop").forEach(d=>{
      const r=d.getBoundingClientRect();
      const inside = e.clientX>r.left && e.clientX<r.right && e.clientY>r.top && e.clientY<r.bottom;
      d.classList.remove("target-glow");
      if(inside) dropped = d.dataset.type;
    });
    // reset card position
    card.style.position=""; card.style.left=""; card.style.top=""; card.style.zIndex="";
    if(dropped){ classify(dropped); }
  });

  // Teclado: H/O/F para soltar; Enter sobre bandeja aplica
  window.addEventListener("keydown", (e)=>{
    if(state.stage!=='mision') return;
    if(e.key==='1') applyTool('fuente');
    else if(e.key==='2') applyTool('evidencia');
    else if(e.key==='3') applyTool('intencion');
    else if(/^[hH]$/.test(e.key)) classify('HECHO');
    else if(/^[oO]$/.test(e.key)) classify('OPINION');
    else if(/^[fF]$/.test(e.key)) classify('FALSA');
  });

  $$(".drop").forEach(d=>{
    d.addEventListener("keydown", (e)=>{
      if(e.key==='Enter' || e.key===' '){
        e.preventDefault();
        classify(d.dataset.type);
      }
    });
  });

  // Acceso por teclado a herramientas
  $$(".tool").forEach(t=>{
    t.addEventListener("keydown", (e)=>{
      if(e.key==='Enter' || e.key===' '){
        e.preventDefault(); applyTool(t.dataset.tool);
      }
    });
    t.addEventListener("click", ()=>applyTool(t.dataset.tool));
  });
}

/* =========================================================
 * FIN DE JUEGO
 * =======================================================*/
function endGame(victory){
  stopMusic();
  showScreen("#screen-resultado");
  const total = casosDetallados.length;
  $("#sumTotal").textContent = String(total);
  $("#sumHechos").textContent = String(state.counts.HECHO);
  $("#sumOpiniones").textContent = String(state.counts.OPINION);
  $("#sumFalsas").textContent = String(state.counts.FALSA);
  $("#sumConf").textContent = String(state.confidence);
  if(victory && state.confidence>0 && state.resolved===total){
    $("#awardTitle").textContent="Premio: Reportero del A√±o";
    $("#trophy").textContent="üèÜ";
    speak("¬°Excelente! Eres Reportero del A√±o.","¬°Reportero del A√±o!");
  }else{
    $("#awardTitle").textContent="El Editor dice: Volvamos a entrenar";
    $("#trophy").textContent="üìù";
    speak("Nos falta pr√°ctica. Volvamos a entrenar.","Volvamos a entrenar");
  }
  $("#finalPhrase").textContent = "Un hecho es dato; opini√≥n es sentir. Yo los distingo para no confundir.";
}

/* =========================================================
 * EVENTOS DE UI (Inicio, Modal, Controles)
 * =======================================================*/
$("#btn-jugar").addEventListener("click", ()=>{
  runBriefing();
});
$("#btn-como").addEventListener("click", ()=> openHow(true));
$("#btn-credits").addEventListener("click", ()=>{
  speak("Juego did√°ctico sin librer√≠as externas. Sonido y m√∫sica generados con audio web.","Juego did√°ctico sin librer√≠as");
});
$("#btn-acces").addEventListener("click", ()=> {
  speak("Activa voz, subt√≠tulos o alto contraste en la barra superior.","Revisa accesibilidad arriba");
});

/* Modal C√≥mo se juega */
const slides = [
  {illu:"üì∞üß†", cap:"Lee el despacho."},
  {illu:"üîé‚öñÔ∏èüéØ", cap:"Usa las herramientas."},
  {illu:"‚úÖ ü§î üóëÔ∏è", cap:"Arrastra a la bandeja correcta."}
];
let slideIdx=0;
function openHow(open){
  const modal=$("#modal");
  modal.classList.toggle('open', open);
  modal.setAttribute('aria-hidden', open?"false":"true");
  if(open){ showSlide(0); }
}
function showSlide(i){
  slideIdx = (i+slides.length)%slides.length;
  $("#slide-illu").textContent = slides[slideIdx].illu;
  $("#slide-caption").textContent = slides[slideIdx].cap;
  $$(".dot").forEach((d,j)=> d.classList.toggle('active', j===slideIdx));
}
$("#prevSlide").addEventListener("click", ()=>showSlide(slideIdx-1));
$("#nextSlide").addEventListener("click", ()=>showSlide(slideIdx+1));
$("#closeModal").addEventListener("click", ()=>openHow(false));
$("#btn-entendido").addEventListener("click", ()=> startMission());

/* Controles del panel derecho */
$("#btn-retry").addEventListener("click", ()=> { state.order=[0,1,2,3,4]; startMission(); });
$("#btn-toggle-voice").addEventListener("click", ()=>{
  state.voiceOn = !state.voiceOn;
  $("#btn-toggle-voice").textContent = state.voiceOn? "üîá Silenciar Voz" : "üîä Activar Voz";
  if(!state.voiceOn) speechSynthesis?.cancel();
});
$("#btn-toggle-captions").addEventListener("click", ()=>{
  state.captionsOn = !state.captionsOn;
  $("#btn-toggle-captions").textContent = state.captionsOn? "üí¨ Subt√≠tulos" : "üí¨ Subt√≠tulos: OFF";
});

/* Toggles del header (sincronizados) */
$("#tg-music").addEventListener("change", (e)=>{
  state.musicOn = e.target.checked; if(state.stage==='mision'){ startMusic(); } else { if(!state.musicOn) stopMusic(); }
});
$("#tg-voice").addEventListener("change", (e)=>{
  state.voiceOn = e.target.checked;
  if(!state.voiceOn) speechSynthesis?.cancel();
});
$("#tg-captions").addEventListener("change", (e)=>{ state.captionsOn = e.target.checked; });
$("#tg-contrast").addEventListener("change", (e)=>{ document.body.classList.toggle('alto-contraste', e.target.checked); });
$("#tg-cvd").addEventListener("change", (e)=>{ document.body.classList.toggle('daltonismo', e.target.checked); });

/* Bot√≥n accesibilidad dentro misi√≥n */
$("#btn-access").addEventListener("click", ()=>{
  speak("Puedes alternar alto contraste o daltonismo en la parte superior.","Ajusta contraste o daltonismo");
});

/* Bot√≥n volver a jugar */
$("#btn-jugar-de-nuevo").addEventListener("click", ()=>{
  state.order=[0,1,2,3,4];
  showScreen("#screen-inicio");
});

/* =========================================================
 * AYUDA: mezclado aleatorio (preparado para ‚Äú√öltima Hora‚Äù)
 * =======================================================*/
function shuffle(a){
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

/* =========================================================
 * INICIALIZACI√ìN
 * =======================================================*/
function init(){
  // Briefing: sellos ya listos, herramientas clicables
  $("#stamp1").classList.remove("show");
  $("#stamp2").classList.remove("show");
  // Misma l√≥gica de herramientas en briefing (did√°ctico, no altera juego)
  $$("#screen-brief .tool").forEach(t=>{
    t.addEventListener("click", ()=>{
      const txt = t.dataset.tool==="fuente" ? "¬øQui√©n lo dice?" : t.dataset.tool==="evidencia" ? "¬øSe puede comprobar?" : "¬øPor qu√© lo publican?";
      speak(txt, txt);
    });
  });
  // Drag
  setupDrag();
  // M√∫sica parada en inicio
  stopMusic();
}
init();

/* Acciones accesibles: clic en bandejas */
$$(".drop").forEach(d=> d.addEventListener("click", ()=> classify(d.dataset.type)));

/* =========================================================
 * ACCIONES DE USUARIO (con poco texto en pantalla)
 * =======================================================*/

/* ===================== FIN: UTILES EXTRA ===================== */
</script>
</body>
</html>
